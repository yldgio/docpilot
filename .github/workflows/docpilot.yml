name: DocPilot - Documentation Sync

on:
  pull_request:
    types: [opened, synchronize]
    # IMPORTANT: Path filter to prevent infinite loops
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/workflows/docpilot.yml'

  workflow_dispatch:
    inputs:
      base_ref:
        description: 'Base ref for comparison'
        required: false
        default: 'main'
      head_ref:
        description: 'Head ref for comparison'
        required: false
        default: 'HEAD'

env:
  DOTNET_VERSION: '10.0.x'
  DOCPILOT_VERSION: 'latest'

jobs:
  analyze-and-generate:
    name: Analyze & Generate Docs
    runs-on: ubuntu-latest
    
    # Skip if PR is from docpilot branch (prevents infinite loops)
    if: "!startsWith(github.head_ref, 'docpilot/')"
    
    permissions:
      contents: write
      pull-requests: write
    
    outputs:
      has_changes: ${{ steps.analyze.outputs.has_changes }}
      pr_url: ${{ steps.create-pr.outputs.pr_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Setup GitHub Copilot CLI
        run: gh extension install github/gh-copilot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install DocPilot
        run: |
          # Option 1: Install from NuGet (when published)
          # dotnet tool install -g docpilot
          
          # Option 2: Build from source (for development)
          dotnet build src/DocPilot/DocPilot.csproj -c Release
      
      - name: Analyze changes
        id: analyze
        run: |
          BASE_REF="${{ github.event.inputs.base_ref || github.base_ref }}"
          HEAD_REF="${{ github.event.inputs.head_ref || github.head_ref }}"
          
          echo "Analyzing changes between $BASE_REF and $HEAD_REF"
          
          # Run analysis
          ANALYSIS=$(dotnet run --project src/DocPilot -- analyze \
            --base "$BASE_REF" \
            --head "$HEAD_REF" \
            --output json)
          
          echo "Analysis output:"
          echo "$ANALYSIS"
          
          # Check if there are documentation targets
          HAS_CHANGES=$(echo "$ANALYSIS" | jq -r '.mapping.targets | length > 0')
          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          
          # Save analysis for next step
          echo "$ANALYSIS" > /tmp/analysis.json
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate documentation
        if: steps.analyze.outputs.has_changes == 'true'
        id: generate
        run: |
          BASE_REF="${{ github.event.inputs.base_ref || github.base_ref }}"
          HEAD_REF="${{ github.event.inputs.head_ref || github.head_ref }}"
          
          echo "Generating documentation updates..."
          
          dotnet run --project src/DocPilot -- generate \
            --base "$BASE_REF" \
            --head "$HEAD_REF"
          
          # Check for changes
          if git diff --quiet; then
            echo "No documentation changes generated"
            echo "generated=false" >> $GITHUB_OUTPUT
          else
            echo "Documentation changes generated"
            echo "generated=true" >> $GITHUB_OUTPUT
            
            # List changed files
            git diff --name-only
          fi
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create documentation PR
        if: steps.generate.outputs.generated == 'true'
        id: create-pr
        run: |
          # Configure git
          git config --global user.name "DocPilot Bot"
          git config --global user.email "docpilot[bot]@users.noreply.github.com"
          
          # Create branch
          BRANCH_NAME="docpilot/docs-$(date +%Y%m%d%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          # Stage and commit changes
          git add -A
          git commit -m "docs: update documentation for recent changes"
          
          # Push branch
          git push origin "$BRANCH_NAME"
          
          # Create PR
          PR_URL=$(gh pr create \
            --title "ðŸ“ docs: Automated documentation update" \
            --body "This PR was automatically generated by DocPilot to keep documentation in sync with code changes.
            
            ## Changes
            
            $(git diff --name-only HEAD~1)
            
            ---
            *Generated with â¤ï¸ by DocPilot*" \
            --base "${{ github.base_ref || 'main' }}" \
            --head "$BRANCH_NAME" \
            --label "documentation,docpilot")
          
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR: $PR_URL"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Comment on original PR
        if: steps.create-pr.outputs.pr_url != '' && github.event_name == 'pull_request'
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "ðŸ“ **DocPilot** has detected that this PR may require documentation updates.
            
            A documentation PR has been created: ${{ steps.create-pr.outputs.pr_url }}
            
            Please review the suggested changes and merge if appropriate."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "## DocPilot Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.analyze.outputs.has_changes }}" == "true" ]; then
            echo "âœ… Documentation targets identified" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ No documentation changes needed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -n "${{ steps.create-pr.outputs.pr_url }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“ Documentation PR: ${{ steps.create-pr.outputs.pr_url }}" >> $GITHUB_STEP_SUMMARY
          fi
